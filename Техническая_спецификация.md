Техническая спецификация — Ferum Customizations
1. План реализации проекта
Этап 1: Настройка инфраструктуры и базовой среды
[ ] Серверная инфраструктура
[ ] Подготовить виртуальный или физический сервер с Ubuntu LTS.
[ ] Установить Docker и Docker Compose.
[ ] Настроить сетевое окружение и доступ по HTTPS.
[ ] Развертывание ERPNext
[ ] Создать docker-compose.yml с сервисами: frappe/erpnext, postgres, redis, nginx.
[ ] Настроить .env с секретами (пароли, ключи).
[ ] Запустить контейнеры и проверить корректность работы.
[ ] Создание сайта ERPNext
[ ] Создать сайт erp.ferumrus.ru.
[ ] Установить кастомное приложение ferum_customs.
[ ] Настроить компанию, валюту и налоги.
[ ] Git и CI/CD
[ ] Инициализировать Git-репозиторий.
[ ] Настроить pre-commit хуки (linting, форматирование).
[ ] Настроить GitHub Actions для автоматического запуска тестов.
Этап 2: Разработка модулей ERPNext
[ ] Проекты и Объекты обслуживания
[ ] Создать DocTypes: ServiceProject, ServiceObject, ProjectObjectItem.
[ ] Определить поля: детали контракта, клиент, SLA, сроки, сумма, статус.
[ ] Реализовать логику: проверка уникальности объектов, запрет на удаление активных объектов.
[ ] Сервисные заявки
[ ] Создать DocType: ServiceRequest.
[ ] Реализовать логику: строгий жизненный цикл (workflow), проверка SLA, эскалация, автозаполнение данных.
[ ] Отчеты о работах
[ ] Создать DocType: ServiceReport с дочерними таблицами.
[ ] Реализовать логику: авто-суммирование из списка работ, привязка к заявке при отправке.
[ ] Финансы
[ ] Создать DocType: Invoice.
[ ] Реализовать логику: статусы, синхронизация с Google Sheets.
[ ] Кадры и Зарплата
[ ] Создать DocType: PayrollEntryCustom.
[ ] Документы и Вложения
[ ] Создать DocType: CustomAttachment, реализовать интеграцию с Google Drive.
Этап 3: Роли, права доступа и безопасность
[ ] Роли
[ ] Создать роли: Администратор, Директор, Бухгалтер, Руководитель отдела, Менеджер проектов, Инженер, Офис-менеджер, Клиент.
[ ] Права доступа
[ ] Настроить матрицу прав доступа согласно спецификации.
[ ] Безопасность
[ ] Внедрить 2FA, настроить HTTPS, автоматизировать резервное копирование.
Этап 4: Внешний бэкенд, API и интеграции
[ ] Бэкенд на FastAPI
[ ] Разработать эндпоинты: /projects, /requests, /reports, /invoices.
[ ] Реализовать аутентификацию через JWT + 2FA и проверку ролей.
[ ] Интеграции с Google
[ ] Drive: загрузка/удаление файлов, хранение ссылок в ERPNext.
[ ] Sheets: автоматическая синхронизация счетов.
[ ] Боты
[ ] Разработать бота для Telegram (Aiogram).
[ ] (Опционально) Разработать бота для WhatsApp.
Этап 5: Мониторинг, аналитика и тестирование
[ ] Мониторинг
[ ] Интегрировать Sentry для отслеживания ошибок.
[ ] Интегрировать Prometheus для сбора метрик.
[ ] Аналитика
[ ] Создать кастомные отчеты в ERPNext.
[ ] Реализовать API для получения KPI ботом.
[ ] Тестирование
[ ] Написать Unit-тесты и E2E-тесты.
[ ] Staging-среда
[ ] Настроить отдельное окружение для тестирования перед релизами.
2. Диаграммы бизнес-процессов (BPMN)
2.1. Управление проектами и контрактами
@startuml
title Управление проектами и контрактами

|Менеджер проектов|
start
:Получить информацию о новом контракте;
:Собрать документацию и ТЗ;
:Связаться с клиентом для подтверждения деталей;
if (Требуются субподрядчики?) then (да)
    :Найти и согласовать субподрядчика;
    :Заключить договор с субподрядчиком;
    :Получить необходимые сертификаты;
else (нет)
    :Спланировать выполнение внутренними силами;
endif
:Создать запись "Service Project" в ERPNext;
:Привязать объекты обслуживания (Service Objects);
note right
  Система проверяет уникальность
  объектов в рамках активных проектов.
end note
:Установить статус проекта "Активен";
|Система|
:Отправить приветственное письмо клиенту;
:Отправить уведомление руководству в Telegram;
stop
@enduml


2.2. Управление сервисными заявками
@startuml
title Управление сервисными заявками

|Клиент/Сотрудник|
start
:Создать "Service Request";
note right: Через портал, бота или ERPNext
|Система|
:Присвоить заявке статус "Open";
:Отправить уведомление ответственному лицу;
|Руководитель/Менеджер|
:Назначить инженера на заявку;
|Система|
:Отправить уведомление инженеру;
|Инженер|
:Принять заявку в работу;
|Система|
:Изменить статус на "In Progress";
|Инженер|
:Выполнить работы на объекте;
:Прикрепить фотоотчеты;
:Создать "Service Report";
|Система|
:Изменить статус на "Completed";
|Менеджер/Руководитель|
:Проверить отчет и закрыть заявку;
|Система|
:Изменить статус на "Closed";
stop
@enduml


2.3. Формирование отчетов о работах
@startuml
title Формирование отчетов о работах (Service Report)

|Инженер/Менеджер|
start
:Создать "Service Report" из заявки;
:Заполнить список выполненных работ (Work Items);
:Прикрепить документы (скан акта, фото);
|Система|
:Автоматически рассчитать итоговую сумму;
|Инженер/Менеджер|
:Отправить отчет (Submit);
|Система|
:Привязать отчет к "Service Request";
:Автоматически изменить статус заявки на "Completed";
:Сгенерировать PDF-версию отчета;
:Загрузить вложения в Google Drive;
|Менеджер|
:Отправить PDF-отчет клиенту;
stop
@enduml


2.4. Выставление счетов и платежи
@startuml
title Выставление счетов и платежи

split
|Менеджер проектов|
start
:Создать "Invoice" для клиента;
|Система|
:Синхронизировать данные со счетом в Google Sheets;
|Менеджер проектов|
:Отправить счет и акты клиенту;
:Отслеживать оплату;
|Бухгалтер|
:Отметить счет как "Paid" после получения оплаты;
stop
split again
|Офис-менеджер/Менеджер|
start
:Получить счет от субподрядчика;
:Создать "Invoice" (тип: Payable) в системе;
:Прикрепить скан-копии документов;
|Система|
:Синхронизировать данные со счетом в Google Sheets;
:Отправить уведомление администратору/бухгалтеру;
|Бухгалтер|
:Провести оплату счета;
:Отметить счет как "Paid";
stop
endsplit
@enduml


3. Модель данных (ERD)
3.1. Общая ERD
@startuml
title Общая диаграмма сущностей (ERD)

entity Customer
entity ServiceProject
entity ServiceObject
entity ServiceRequest
entity ServiceReport
entity Invoice
entity CustomAttachment
entity Employee
entity User

Customer ||--|{ ServiceProject
Customer ||--|{ ServiceObject
ServiceProject ||--|{ ServiceObject : "через ProjectObjectItem"
ServiceProject ||--|{ ServiceRequest
ServiceProject ||--|{ Invoice
ServiceObject ||--|{ ServiceRequest
ServiceRequest ||--|| ServiceReport
ServiceRequest ||--|{ CustomAttachment : "через RequestPhotoAttachmentItem"
ServiceReport ||--|{ CustomAttachment : "через ServiceReportDocumentItem"
User ||--o| Employee
ServiceRequest "1" -- "0..1" Employee : "assigned_to"

@enduml


3.2. Диаграммы для каждого DocType
ServiceProject
@startuml
class ServiceProject {
  + name: String (ID)
  --
  + customer: Link(Customer)
  + project_name: String
  + start_date: Date
  + end_date: Date
  + status: Select ("Planned", "Active", "Completed")
  + total_amount: Currency
  + project_manager: Link(User)
  --
  + objects: Table(ProjectObjectItem)
}
@enduml


ServiceObject
@startuml
class ServiceObject {
  + name: String (ID)
  --
  + object_name: String
  + address: Small Text
  + customer: Link(Customer)
  + type: String
  + project: Link(ServiceProject)
}
@enduml


ServiceRequest
@startuml
class ServiceRequest {
  + name: String (ID)
  --
  + title: String
  + description: Text
  + type: Select ("Routine", "Emergency")
  + priority: Select ("Low", "Medium", "High")
  + status: Select ("Open", "In Progress", "Completed", "Closed")
  + service_object: Link(ServiceObject)
  + project: Link(ServiceProject)
  + customer: Link(Customer)
  + assigned_to: Link(User)
  + linked_report: Link(ServiceReport)
  --
  + photos: Table(RequestPhotoAttachmentItem)
}
@enduml


ServiceReport
@startuml
class ServiceReport {
  + name: String (ID)
  --
  + service_request: Link(ServiceRequest)
  + report_date: Date
  + status: Select ("Draft", "Submitted")
  + total_amount: Currency (read-only)
  --
  + work_items: Table(ServiceReportWorkItem)
  + documents: Table(ServiceReportDocumentItem)
}
@enduml


Invoice
@startuml
class Invoice {
  + name: String (ID)
  --
  + project: Link(ServiceProject)
  + period: String
  + amount: Currency
  + counterparty_name: String
  + counterparty_type: Select ("Customer", "Subcontractor")
  + status: Select ("Draft", "Sent", "Paid")
}
@enduml


CustomAttachment
@startuml
class CustomAttachment {
  + name: String (ID)
  --
  + file_name: String
  + file_url: String (ссылка на Google Drive)
  + file_type: String
  + uploaded_by: Link(User)
  + uploaded_on: Datetime
}
@enduml


PayrollEntryCustom
@startuml
class PayrollEntryCustom {
  + name: String (ID)
  --
  + period_start: Date
  + period_end: Date
  + total_payroll_amount: Currency
  + status: Select ("Draft", "Completed")
  --
  + employees: Table(PayrollEntryItem)
}
@enduml


4. Диаграммы жизненного цикла (Workflow)
4.1. ServiceRequest Workflow
@startuml
title Жизненный цикл сервисной заявки (ServiceRequest)

state "Open" as Open
state "In Progress" as InProgress
state "Completed" as Completed
state "Closed" as Closed
state "Cancelled" as Cancelled

[*] --> Open : Создание
Open --> InProgress : Назначить инженера
InProgress --> Open : Вернуть в работу
InProgress --> Completed : Завершить работы и подать отчет
Completed --> Closed : Проверить и закрыть (Менеджер)
Completed --> InProgress : Отправить на доработку
Open --> Cancelled : Отменить
InProgress --> Cancelled : Отменить
Closed --> [*]
Cancelled --> [*]

@enduml


4.2. ServiceReport Workflow
@startuml
title Жизненный цикл отчета о работах (ServiceReport)

state "Draft" as Draft
state "Submitted" as Submitted
state "Cancelled" as Cancelled

[*] --> Draft : Создание
Draft --> Submitted : Отправить (Submit)
Submitted --> Draft : Вернуть на доработку (Amend)
Draft --> Cancelled : Отменить
Submitted --> Cancelled : Аннулировать (только Администратор)
Submitted --> [*]
Cancelled --> [*]

@enduml


4.3. Invoice Workflow
@startuml
title Жизненный цикл счета (Invoice)

state "Draft" as Draft
state "Sent" as Sent
state "Paid" as Paid
state "Overdue" as Overdue
state "Cancelled" as Cancelled

[*] --> Draft : Создание
Draft --> Sent : Отправить клиенту / Утвердить к оплате
Sent --> Paid : Отметить как оплаченный
Sent --> Overdue : Просрочен
Overdue --> Paid : Отметить как оплаченный
Draft --> Cancelled : Отменить
Sent --> Cancelled : Отменить
Paid --> [*]
Cancelled --> [*]

@enduml


5. Definition of Ready / Definition of Done
5.1. Definition of Ready (DoR)
Критерии, которым должна соответствовать задача перед началом работы:
Требования ясны: Задача четко описана в таск-трекере (например, Jira, Trello).
Критерии приемки определены: Известно, как будет проверяться результат (User Story и Acceptance Criteria).
Зависимости разрешены: Все блокирующие задачи (например, готовый дизайн, доступы к API) выполнены.
Технический дизайн продуман: Команда обсудила и согласовала подход к реализации.
Тестовые данные подготовлены: Есть понимание, какие данные нужны для тестирования, и они доступны.
5.2. Definition of Done (DoD)
Критерии, которым должна соответствовать задача по завершении работы:
Код написан и соответствует стандартам: Проходит все проверки линтеров и соответствует стайлгайду проекта.
Функциональность реализована: Все критерии приемки из User Story выполнены.
Тесты написаны и пройдены: Unit-тесты и (где применимо) интеграционные тесты покрывают новую логику.
Документация обновлена: Техническая спецификация, комментарии в коде и пользовательская документация актуализированы.
Код прошел ревью: Pull Request был рассмотрен и одобрен как минимум одним другим разработчиком.
Развернуто на Staging: Изменения успешно развернуты на тестовом окружении и прошли регрессионное тестирование.
(Для релиза) Развернуто на Production: Изменения успешно выкачены в продакшен.
